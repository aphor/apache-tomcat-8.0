<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title>Tic Tac Toe - Cometd Example</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="resources/tictactoe.css">

        <script type="text/javascript" src="../dojo/dojo/dojo.js"></script>
        <script type="text/javascript" src="../dojo/dojox/cometd.js.uncompressed.js"></script>

        <script type="text/javascript">

            dojo.require("dojox.cometd");

            var X = 10;
            var O = 1;
   
            var board = new Array(9);
            var wins = new Array(8);

            var turnNum = 0;
            var winner = -1;

            var iam = 0;

            dojo.addOnLoad(function() {
                initArrays();
                dojox.cometd.init("/cometd/cometd");
                dojox.cometd.subscribe("/demo/tictactoe", onMsgEvent);
            });

            function postMe(arg) {
                var move = eval(arg);
                if (iam == 0 && this.win() != -1) {
                    dojo.byId("myrole").innerHTML = "Game is over.";
                    return;
                }
                if (iam == 0 && turnNum > 1) {
                    dojo.byId("gstatus").innerHTML = "Sorry, you will have to wait until this game ends.";
                    return;
                }
                if (iam != 0 && this.whoseTurn() != iam) {
                    dojo.byId("gstatus").innerHTML = "Not your turn.";
                    return;
                }
                if (! this.turn(move)) {
                    dojo.byId("gstatus").innerHTML = "Not a valid move try again";
                    return;
                }
                var win = this.win();
                var turn = this.whoseTurn();

                var data = { 'move': move, 'win': win, 'turn': turn, 'board': board, 'turnNum': turnNum };
                dojox.cometd.publish("/demo/tictactoe", data);
                onMsgEvent({ 'data': data});
                
            };

            function onMsgEvent(event) {
                
                var data = event.data

                for (i = 0; i < 9; i++) {
                    // 0 is blank, 10 is x, 1 is o
                    dojo.byId("img" + i).src = "resources/" + data.board[i] + ".gif";
                }
                
                var statusMsg;  
                // -1 is unfinished, 0 is tie, 1 is X win, 2 is Y win
                if (data.win == 0) {
                    statusMsg = "It's a tie!";
                } else if (data.win == 1) {
                    statusMsg = "X wins!";
                } else if (data.win == 2) {
                    statusMsg = "O wins!";
                } else if (data.win == -1 && data.turn == 10) {  
                    statusMsg = "It's X's Turn";
                } else if (data.win == -1 && data.turn == 1) {
                    statusMsg = "It's O's Turn";
                } else {
                    statusMsg = "That's odd, it shouldn't get here";
                }

                if (iam == 0) {
                    if (turnNum == 0) {
                        dojo.byId("myrole").innerHTML = "You can join the game if you'd like.";
                    } else {
                        dojo.byId("myrole").innerHTML = "You are currently a spectator.";
                    }
                } else if (iam == X) {
                    dojo.byId("myrole").innerHTML = "You are currently player 'X'.";
                } else {
                    dojo.byId("myrole").innerHTML = "You are currently player 'O'.";
                }
                
                if (data.win != -1) {
                    statusMsg = statusMsg + '<br><a href="ttt1.html">Restart the game</a>';
                }
        
                // And write the status message out here -
                dojo.byId("gstatus").innerHTML = statusMsg;

                board = data.board;
                winner = data.win;
                turnNum = data.turnNum;
            }

            //return false if cell is an invalid move
            function turn(cell) {
                if (cell < 0 || cell > 8) return false; // invalid move
                if (winner != -1) return false;
                if (iam == 0) {
                    if (iam == 0 && turnNum == 0) {
                        iam = X;
                    }
                    else {
                        iam = O;
                    }
                }
                if (board[cell] != 0) {
                    return false; // invalid move
                }
                turnNum++;
                if (turnNum % 2 == 1) { //then X
                    board[cell] = X;
                } else { // else O
                    board[cell] = O;
                }
                return true;
            }

            function whoseTurn() {
                if (turnNum == 0 || turnNum % 2 == 0 ) {
                    return X;
                } else return O;
            }

    
            function done() {
                return (turnNum > 8);
            }
            
            
            // return -1 for no win, 0 for tie, 1 for x win, 2 for o win
            function win() {
                if (winner != -1) {
                    return winner;
                }
                for (i = 0 ; i < 8; i++) {
                    var winSum = board[wins[i][0]] + board[wins[i][1]] + board[wins[i][2]];
                    if (winSum == 3) {
                        winner = 2;
                    } else if (winSum == 30) {
                        winner = 1;
                    }
                }
                if (winner == -1 && turnNum > 8) {
                    winner = 0;
                } 
                return winner;
            }
 

            function initArrays() {

                wins[0] = new Array(3);
                wins[0][0] = 0;
                wins[0][1] = 1;
                wins[0][2] = 2;

                wins[1] = new Array(3);
                wins[1][0] = 3;
                wins[1][1] = 4;
                wins[1][2] = 5;

                wins[2] = new Array(3);
                wins[2][0] = 6;
                wins[2][1] = 7;
                wins[2][2] = 8;

                wins[3] = new Array(3);
                wins[3][0] = 0;
                wins[3][1] = 3;
                wins[3][2] = 6;

                wins[4] = new Array(3);
                wins[4][0] = 1;
                wins[4][1] = 4;
                wins[4][2] = 7;

                wins[5] = new Array(3);
                wins[5][0] = 2;
                wins[5][1] = 5;
                wins[5][2] = 8;

                wins[6] = new Array(3);
                wins[6][0] = 0;
                wins[6][1] = 4;
                wins[6][2] = 8;

                wins[7] = new Array(3);
                wins[7][0] = 2;
                wins[7][1] = 4;
                wins[7][2] = 6;

                board[0] = 0;
                board[1] = 0;
                board[2] = 0;
                board[3] = 0;
                board[4] = 0;
                board[5] = 0;
                board[6] = 0;
                board[7] = 0;
                board[8] = 0;
            }

        </script>
        
    </head>
    <body>
        
        <h1>Tic Tac Toe</h1>
        <table>
            <tr>
                <td id="cell0"><img id="img0" src="resources/0.gif" 
                                    onclick=postMe("0")></td>
                <td id="cell1"><img id="img1" src="resources/0.gif" 
                                    onclick=postMe("1")></td>
                <td id="cell2"><img id="img2" src="resources/0.gif" 
                                    onclick=postMe("2")></td>
            </tr>
            <tr>
                <td id="cell3"><img id="img3" src="resources/0.gif" 
                                    onclick=postMe("3")></td>
                <td id="cell4"><img id="img4" src="resources/0.gif" 
                                    onclick=postMe("4")></td>
                <td id="cell5"><img id="img5" src="resources/0.gif" 
                                    onclick=postMe("5")></td>
            </tr>
            <tr>
                <td id="cell6"><img id="img6" src="resources/0.gif" 
                                    onclick=postMe("6")></td>
                <td id="cell7"><img id="img7" src="resources/0.gif" 
                                    onclick=postMe("7")></td>
                <td id="cell8"><img id="img8" src="resources/0.gif" 
                                    onclick=postMe("8")></td>
            </tr>      
        </table>
        <h2 id="gstatus">New game, click to start.</h2><br/>
        <h2 id="myrole"></h2>
    </body>
</html>
